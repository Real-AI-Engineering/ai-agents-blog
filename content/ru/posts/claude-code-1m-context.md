---
title: "Claude Code: включаем контекст 1 000 000 токенов (Sonnet 4) и настраиваем рабочую среду"
date: 2025-08-27
tags:
  - Claude Code
  - Sonnet 4
  - 1M context
  - CLI
  - Sub-agents
summary: Пошаговая инструкция по включению Sonnet 4 [1m] в CLI, организации памяти проекта (CLAUDE.md), и настройке суб‑агентов для full‑stack‑разработки.
---

# Как включить и правильно использовать контекст **1 000 000 токенов** в Claude Code (Sonnet 4)

> **Кратко:**  
> 1) Запусти `claude`.  
> 2) Набери `/model` и выбери **Sonnet 4 [1m]** (или укажи вручную: `/model sonnet[1m]`).  
> 3) Проверь активную модель: `/status`.  
> 4) Сохрани «инвариантный» контекст в `CLAUDE.md`.  
> 5) Разделяй роли с помощью **суб‑агентов** в `.claude/agents/`.  
> 6) Управляй историей: `/compact` (сжать), `/clear` (начать следующий этап на «чистом» контексте).

---

## Оглавление

- [1. Включение контекста 1M в CLI](#1-включение-контекста-1m-в-cli)  
- [2. Память проекта: `CLAUDE.md` и импорт знаний](#2-память-проекта-claudemd-и-импорт-знаний)  
- [3. Суб‑агенты: изоляция контекста и специализация](#3-суб-агенты-изоляция-контекста-и-специализация)  
- [4. Шаблоны работы: план → код → тесты → ревью → дока → деплой](#4-шаблоны-работы-план--код--тесты--ревью--дока--деплой)  
- [5. Управление историей и стоимостью](#5-управление-историей-и-стоимостью)  
- [6. Готовые файлы: `CLAUDE.md` и суб‑агенты](#6-готовые-файлы-claudemd-и-суб-агенты)  
- [7. Быстрый старт (скрипт)](#7-быстрый-старт-скрипт)  
- [FAQ и источники](#faq-и-источники)

---

## 1. Включение контекста 1M в CLI

**Шаги:**
1. Запусти интерактивный REPL:
   ```bash
   claude
   ```
2. Переключи модель:
   ```text
   /model
   ```
   В меню выбери **Sonnet 4 [1m]**. Если варианта нет, попробуй явный ввод:
   ```text
   /model sonnet[1m]
   ```
3. Проверь активную модель и настройки:
   ```text
   /status
   ```

---

## 2. Память проекта: `CLAUDE.md` и импорт знаний

Чтобы **сохранить контекст между сессиями** (архитектура, правила код‑стайла, команды сборки/тестов, ссылки на документацию), создай файл `CLAUDE.md` в корне репозитория. Его содержимое **автоматически подхватывается** при запуске Claude Code и дополняет системный контекст. Храни там только **инвариант** (то, что полезно на протяжении всего проекта).

> Где хранить память: глобально — `~/.claude/CLAUDE.md`, на уровне проекта — `./CLAUDE.md`. Можно комбинировать (глобальные предпочтения + специфика проекта).

---

## 3. Суб‑агенты: изоляция контекста и специализация

**Суб‑агенты** — это специализированные «мини‑ассистенты» с **собственным системным промптом, набором инструментов и отдельным контекстным окном**, которых основной агент Claude может вызывать проактивно (по описанию) или по явной команде. Они помогают **не «засорять» основную историю** длинными логами тестов, ревью и т. п., и делают пайплайны более воспроизводимыми. Хранятся в:  
- проект: `.claude/agents/*.md`  
- пользователь: `~/.claude/agents/*.md`  
Формат — Markdown с YAML‑шапкой.

---

## 4. Шаблоны работы: план → код → тесты → ревью → дока → деплой

Пример диалога (после включения `[1m]`):

```text
Сформируй план фичи на основе docs/architecture.md и docs/openapi.yaml.
Разбей на MVP / Next. Оформи чек-листами.

Приступаем к MVP/Шаг 1 — реализация backend-эндпойнта по спецификации.
После изменений:
- вызови test-runner суб-агента для прогона тестов и фиксов до green,
- затем code-reviewer для ревью изменений,
- и doc-writer — обновить README/API-раздел.

В конце попроси deploy-manager — подготовить Docker и GitHub Actions workflow.
```

> Подсказка: если файл(ы) уже в репозитории, просто укажи их пути (модель сама прочитает). При необходимости — разреши `Read/Edit/Bash` (см. `/config`/флаги CLI).

---

## 5. Управление историей и стоимостью

- **Сжимай историю** перед новым этапом, сохраняя выжимку:  
  ```text
  /compact Суммируй решения и оставшиеся задачи кратко
  ```
- **Очищай контекст** для следующего этапа:  
  ```text
  /clear
  ```
- **Смотри доступные slash‑команды** и пользуйся ими по назначению.

---

## 6. Готовые файлы: `CLAUDE.md` и суб‑агенты

> Скопируй как есть, затем подправь команды под свой проект.

### 6.1 `CLAUDE.md` (память проекта)

```markdown
# Проект: MyAIApp

## Архитектура и артефакты
- Архитектура: docs/architecture.md
- Контракты API: docs/openapi.yaml
- Руководство запуска: docs/runbook.md
- Решения и статус: STATUS.md (вести краткие итоги этапов)
- План работ: PLAN.md (MVP/Next, чек-листы)

## Технологический стек
- Backend: Python (pytest) / Go (go test) / Rust (cargo test)
- Frontend: TypeScript + React (vitest/jest)
- Контейнеризация: Docker
- CI/CD: GitHub Actions

## Команды по умолчанию (подправь под проект)
### Python
- Установка: `pip install -r requirements.txt`
- Тесты: `pytest -q`
- Линт: `ruff check .` или `flake8`

### Go
- Тесты: `go test ./...`
- Линт: `golangci-lint run`

### Rust
- Тесты: `cargo test`
- Линт: `cargo clippy -- -D warnings`

### TypeScript / React
- Установка: `pnpm i` или `npm ci`
- Тесты: `pnpm test` или `npm test`
- Линт: `pnpm lint` или `npm run lint`
- Билд: `pnpm build` или `npm run build`

### Docker
- Сборка: `docker build -t myapp:local .`
- Локальный запуск: `docker compose up --build`

### GitHub Actions
- Основной workflow: `.github/workflows/ci.yml`
- Требование: запуск юнит‑тестов на PR и статический анализ

## Политика кода
- Стиль: 2 пробела отступ, self‑documenting names, no default export
- Безопасность: секреты — только через env/secret manager, никакого hard‑code
- Тест‑критерий: P0 сценарии обязаны иметь юнит‑тесты

## Как помогать себе при работе
- Всегда начинай с ПЛАНА (чек‑лист в PLAN.md).
- По завершении этапа: обнови STATUS.md и сделай `/compact`, затем `/clear`.
```

---

### 6.2 `.claude/agents/test-runner.md`

```markdown
---
name: test-runner
description: Use proactively to run tests and fix failures.
# tools: (наследует разрешённые по умолчанию: Read/Edit/Bash и т.д.)
---

Ты — инженер по автоматизации тестирования.
Задача:
1) Автоматически определяй подходящую команду для тестов по стэку проекта:
   - Python: `pytest -q`
   - Go: `go test ./...`
   - Rust: `cargo test`
   - TypeScript/React: `pnpm test` или `npm test`
2) Запускай тесты. При падениях:
   - Проанализируй стектрейсы/логи.
   - Предложи минимальные правки с сохранением замысла.
   - Внеси изменения в код, запусти тесты повторно.
3) Повторяй до состояния **зелёных тестов** или чёткого блокера.
Формат ответа:
- Итог: ✅ все тесты прошли / ❌ есть сбои
- Что исправлено (файл/фрагмент, кратко почему)
- Что осталось и почему (если блокер)
```

---

### 6.3 `.claude/agents/code-reviewer.md`

```markdown
---
name: code-reviewer
description: Expert code review. Proactively review after code changes.
tools: Read, Grep, Glob, Bash
---

Ты — опытный ревьюер кода (качество/безопасность/поддерживаемость).
Действия:
1) Извлеки diff последних изменений (`git diff`), сфокусируйся на изменённых файлах.
2) Проверь:
   - Безопасность: инъекции, секреты, десериализация, доступы.
   - Качество: сложность, дубли, пограничные случаи, обработка ошибок.
   - Стиль: соответствие правилам из CLAUDE.md.
3) Дай чёткие рекомендации с примерами правок (до/после).
Формат:
- Critical / Important / Suggestion — списком
- Быстрые фиксы (если тривиально) — предложи патчи
```

---

### 6.4 `.claude/agents/doc-writer.md`

```markdown
---
name: doc-writer
description: Technical documentation writer after significant changes.
tools: Read, Write
---

Ты — технический писатель. После существенных изменений:
1) Обнови README.md (назначение, запуск, примеры).
2) Обнови раздел API (если затронут), синхронизируй с docs/openapi.yaml.
3) Кратко опиши изменения в CHANGELOG.md.
Формат:
- Что добавлено/изменено (1–3 абзаца)
- Как запускать/тестировать
```

---

### 6.5 `.claude/agents/deploy-manager.md`

```markdown
---
name: deploy-manager
description: Deployment & CI/CD specialist for release preparation.
tools: Bash
---

Ты — DevOps-инженер.
Шаги:
1) Оцени, нужны ли миграции БД/переменные окружения/обновления Dockerfile.
2) Подготовь:
   - Dockerfile / docker-compose.yml (если отсутствуют или устарели)
   - GitHub Actions workflow `.github/workflows/ci.yml`:
     - шаги: checkout, setup (lang), install deps, lint, test, build, (опционально) docker build/push
3) Выведи **инструкцию деплоя** (локально и/или в выбранную среду).
4) Не выполняй деструктивные команды; спрашивай подтверждение для пушей/релизов.
```

---

## 7. Быстрый старт (скрипт)

```bash
# 1) Память проекта
cat > CLAUDE.md <<'EOF'
# Проект: MyAIApp
... (вставь содержимое из раздела 6.1 выше) ...
EOF

# 2) Суб-агенты
mkdir -p .claude/agents

cat > .claude/agents/test-runner.md <<'EOF'
... (вставь содержимое 6.2) ...
EOF

cat > .claude/agents/code-reviewer.md <<'EOF'
... (вставь содержимое 6.3) ...
EOF

cat > .claude/agents/doc-writer.md <<'EOF'
... (вставь содержимое 6.4) ...
EOF

cat > .claude/agents/deploy-manager.md <<'EOF'
... (вставь содержимое 6.5) ...
EOF

echo "Готово. Запускай: claude → /model sonnet[1m] → /status"
```

---

## FAQ и источники

- Как поменять модель в Claude Code? — `/model`, текущая — `/status`.
- Где документация по памяти (`CLAUDE.md`)? — раздел Manage Memory в доках.
- Как устроены суб‑агенты и где хранить их файлы? — раздел Subagents.
- Какие есть slash‑команды для контекста? — `/compact` (сжать историю), `/clear` (сбросить историю).
- Где посмотреть флаги CLI (model, tools)? — CLI reference.